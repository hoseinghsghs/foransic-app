(function(i){typeof define=="function"&&define.amd?define(["jquery","jquery-ui/ui/widgets/sortable"],i):i(window.jQuery)})(function(i){function y(s,t,o){return s>t&&s<t+o}i.widget("mjs.nestedSortable",i.extend({},i.ui.sortable.prototype,{options:{disableParentChange:!1,doNotClear:!1,expandOnHover:700,isAllowed:function(){return!0},isTree:!1,listType:"ol",maxLevels:0,protectRoot:!1,rootID:null,rtl:!1,startCollapsed:!1,tabSize:20,branchClass:"mjs-nestedSortable-branch",collapsedClass:"mjs-nestedSortable-collapsed",disableNestingClass:"mjs-nestedSortable-no-nesting",errorClass:"mjs-nestedSortable-error",expandedClass:"mjs-nestedSortable-expanded",hoveringClass:"mjs-nestedSortable-hovering",leafClass:"mjs-nestedSortable-leaf",disabledClass:"mjs-nestedSortable-disabled"},_create:function(){var s=this,t;if(this.element.data("ui-sortable",this.element.data("mjs-nestedSortable")),!this.element.is(this.options.listType))throw t="nestedSortable: Please check that the listType option is set to your actual list type",new Error(t);this.options.isTree&&this.options.expandOnHover&&(this.options.tolerance="intersect"),i.ui.sortable.prototype._create.apply(this,arguments),this.options.isTree&&i(this.items).each(function(){var o=this.item,l=o.hasClass(s.options.collapsedClass),r=o.hasClass(s.options.expandedClass);o.children(s.options.listType).length?(o.addClass(s.options.branchClass),!l&&!r&&(s.options.startCollapsed?o.addClass(s.options.collapsedClass):o.addClass(s.options.expandedClass))):o.addClass(s.options.leafClass)})},_destroy:function(){return this.element.removeData("mjs-nestedSortable").removeData("ui-sortable"),i.ui.sortable.prototype._destroy.apply(this,arguments)},_mouseDrag:function(s){var t,o,l,r,h=this,e=this.options,n=!1,d=i(document),f,p,u,g,v,C,_,x,b,a,c,T;for(this.position=this._generatePosition(s),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll&&(this.scrollParent[0]!==document&&this.scrollParent[0].tagName!=="HTML"?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-s.pageY<e.scrollSensitivity?(n=this.scrollParent.scrollTop()+e.scrollSpeed,this.scrollParent.scrollTop(n)):s.pageY-this.overflowOffset.top<e.scrollSensitivity&&(n=this.scrollParent.scrollTop()-e.scrollSpeed,this.scrollParent.scrollTop(n)),this.overflowOffset.left+this.scrollParent[0].offsetWidth-s.pageX<e.scrollSensitivity?(n=this.scrollParent.scrollLeft()+e.scrollSpeed,this.scrollParent.scrollLeft(n)):s.pageX-this.overflowOffset.left<e.scrollSensitivity&&(n=this.scrollParent.scrollLeft()-e.scrollSpeed,this.scrollParent.scrollLeft(n))):(s.pageY-d.scrollTop()<e.scrollSensitivity?(n=d.scrollTop()-e.scrollSpeed,d.scrollTop(n)):i(window).height()-(s.pageY-d.scrollTop())<e.scrollSensitivity&&(n=d.scrollTop()+e.scrollSpeed,d.scrollTop(n)),s.pageX-d.scrollLeft()<e.scrollSensitivity?(n=d.scrollLeft()-e.scrollSpeed,d.scrollLeft(n)):i(window).width()-(s.pageX-d.scrollLeft())<e.scrollSensitivity&&(n=d.scrollLeft()+e.scrollSpeed,d.scrollLeft(n))),n!==!1&&i.ui.ddmanager&&!e.dropBehaviour&&i.ui.ddmanager.prepareOffsets(this,s)),this.positionAbs=this._convertPositionTo("absolute"),f=this.placeholder.offset().top,(!this.options.axis||this.options.axis!=="y")&&(this.helper[0].style.left=this.position.left+"px"),(!this.options.axis||this.options.axis!=="x")&&(this.helper[0].style.top=this.position.top+"px"),this.hovering=this.hovering?this.hovering:null,this.mouseentered=this.mouseentered?this.mouseentered:!1,(function(){var m=this.placeholder.parent().parent();m&&m.closest(".ui-sortable").length&&(p=m)}).call(this),u=this._getLevel(this.placeholder),g=this._getChildLevels(this.helper),_=document.createElement(e.listType),this.dragDirection={vertical:this._getDragVerticalDirection(),horizontal:this._getDragHorizontalDirection()},t=this.items.length-1;t>=0;t--)if(o=this.items[t],l=o.item[0],r=this._intersectsWithPointer(o),!!r&&o.instance===this.currentContainer){if(l.className.indexOf(e.disabledClass)!==-1){if(r===2){if(v=this.items[t+1],v&&v.item.hasClass(e.disabledClass))continue}else if(r===1&&(C=this.items[t-1],C&&C.item.hasClass(e.disabledClass)))continue}if(x=r===1?"next":"prev",l!==this.currentItem[0]&&this.placeholder[x]()[0]!==l&&!i.contains(this.placeholder[0],l)&&(this.options.type!=="semi-dynamic"||!i.contains(this.element[0],l))){if(this.mouseentered||(i(l).mouseenter(),this.mouseentered=!0),e.isTree&&i(l).hasClass(e.collapsedClass)&&e.expandOnHover&&(this.hovering||(i(l).addClass(e.hoveringClass),this.hovering=window.setTimeout(function(){i(l).removeClass(e.collapsedClass).addClass(e.expandedClass),h.refreshPositions(),h._trigger("expand",s,[h._uiHash(),l])},e.expandOnHover))),this.direction=r===1?"down":"up",this.options.tolerance==="pointer"||this._intersectsWithSides(o))i(l).mouseleave(),this.mouseentered=!1,i(l).removeClass(e.hoveringClass),this.hovering&&window.clearTimeout(this.hovering),this.hovering=null,e.protectRoot&&!(this.currentItem[0].parentNode===this.element[0]&&l.parentNode!==this.element[0])?this.currentItem[0].parentNode!==this.element[0]&&l.parentNode===this.element[0]?(i(l).children(e.listType).length||(l.appendChild(_),e.isTree&&i(l).removeClass(e.leafClass).addClass(e.branchClass+" "+e.expandedClass)),this.direction==="down"?b=i(l).prev().children(e.listType):b=i(l).children(e.listType),b[0]!==void 0&&this._rearrange(s,null,b)):this._rearrange(s,o):e.protectRoot||this._rearrange(s,o);else break;this._clearEmpty(l),this._trigger("change",s,this._uiHash());break}}if((function(){var m=this.placeholder.prev();m.length?a=m:a=null}).call(this),a!=null)for(;a[0].nodeName.toLowerCase()!=="li"||a[0].className.indexOf(e.disabledClass)!==-1||a[0]===this.currentItem[0]||a[0]===this.helper[0];)if(a[0].previousSibling)a=i(a[0].previousSibling);else{a=null;break}if((function(){var m=this.placeholder.next();m.length?c=m:c=null}).call(this),c!=null)for(;c[0].nodeName.toLowerCase()!=="li"||c[0].className.indexOf(e.disabledClass)!==-1||c[0]===this.currentItem[0]||c[0]===this.helper[0];)if(c[0].nextSibling)c=i(c[0].nextSibling);else{c=null;break}return this.beyondMaxLevels=0,p!=null&&c==null&&!(e.protectRoot&&p[0].parentNode==this.element[0])&&(e.rtl&&this.positionAbs.left+this.helper.outerWidth()>p.offset().left+p.outerWidth()||!e.rtl&&this.positionAbs.left<p.offset().left)?(p.after(this.placeholder[0]),T=!p.children(e.listItem).children("li:visible:not(.ui-sortable-helper)").length,e.isTree&&T&&p.removeClass(this.options.branchClass+" "+this.options.expandedClass).addClass(this.options.leafClass),typeof p<"u"&&this._clearEmpty(p[0]),this._trigger("change",s,this._uiHash())):a!=null&&!a.hasClass(e.disableNestingClass)&&(a.children(e.listType).length&&a.children(e.listType).is(":visible")||!a.children(e.listType).length)&&!(e.protectRoot&&this.currentItem[0].parentNode===this.element[0])&&(e.rtl&&this.positionAbs.left+this.helper.outerWidth()<a.offset().left+a.outerWidth()-e.tabSize||!e.rtl&&this.positionAbs.left>a.offset().left+e.tabSize)?(this._isAllowed(a,u,u+g+1),a.children(e.listType).length||(a[0].appendChild(_),e.isTree&&a.removeClass(e.leafClass).addClass(e.branchClass+" "+e.expandedClass)),f&&f<=a.offset().top?a.children(e.listType).prepend(this.placeholder):a.children(e.listType)[0].appendChild(this.placeholder[0]),typeof p<"u"&&this._clearEmpty(p[0]),this._trigger("change",s,this._uiHash())):this._isAllowed(p,u,u+g),this._contactContainers(s),i.ui.ddmanager&&i.ui.ddmanager.drag(this,s),this._trigger("sort",s,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(s){this.beyondMaxLevels&&(this.placeholder.removeClass(this.options.errorClass),this.domPosition.prev?i(this.domPosition.prev).after(this.placeholder):i(this.domPosition.parent).prepend(this.placeholder),this._trigger("revert",s,this._uiHash())),i("."+this.options.hoveringClass).mouseleave().removeClass(this.options.hoveringClass),this.mouseentered=!1,this.hovering&&window.clearTimeout(this.hovering),this.hovering=null,this._relocate_event=s,this._pid_current=i(this.domPosition.parent).parent().attr("id"),this._sort_current=this.domPosition.prev?i(this.domPosition.prev).next().index():0,i.ui.sortable.prototype._mouseStop.apply(this,arguments)},_intersectsWithSides:function(s){var t=this.options.isTree?.8:.5,o=y(this.positionAbs.top+this.offset.click.top,s.top+s.height*t,s.height),l=y(this.positionAbs.top+this.offset.click.top,s.top-s.height*t,s.height),r=y(this.positionAbs.left+this.offset.click.left,s.left+s.width/2,s.width),h=this._getDragVerticalDirection(),e=this._getDragHorizontalDirection();return this.floating&&e?e==="right"&&r||e==="left"&&!r:h&&(h==="down"&&o||h==="up"&&l)},_contactContainers:function(){this.options.protectRoot&&this.currentItem[0].parentNode===this.element[0]||i.ui.sortable.prototype._contactContainers.apply(this,arguments)},_clear:function(){var s,t;for(i.ui.sortable.prototype._clear.apply(this,arguments),this._pid_current===this._uiHash().item.parent().parent().attr("id")&&this._sort_current===this._uiHash().item.index()||this._trigger("relocate",this._relocate_event,this._uiHash()),s=this.items.length-1;s>=0;s--)t=this.items[s].item[0],this._clearEmpty(t)},serialize:function(s){var t=i.extend({},this.options,s),o=this._getItemsAsjQuery(t&&t.connected),l=[];return i(o).each(function(){var r=(i(t.item||this).attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/),h=(i(t.item||this).parent(t.listType).parent(t.items).attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/);r&&l.push((t.key||r[1])+"["+(t.key&&t.expression?r[1]:r[2])+"]="+(h?t.key&&t.expression?h[1]:h[2]:t.rootID))}),!l.length&&t.key&&l.push(t.key+"="),l.join("&")},toHierarchy:function(s){var t=i.extend({},this.options,s),o=[];return i(this.element).children(t.items).each(function(){var r=l(this);o.push(r)}),o;function l(r){var h=(i(r).attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/),e,n=i(r).data();if(n.nestedSortableItem&&delete n.nestedSortableItem,h)return e={id:h[2]},e=i.extend({},e,n),i(r).children(t.listType).children(t.items).length>0&&(e.children=[],i(r).children(t.listType).children(t.items).each(function(){var d=l(this);e.children.push(d)})),e}},toArray:function(s){var t=i.extend({},this.options,s),o=t.startDepthCount||0,l=[],r=1;return t.excludeRoot||(l.push({item_id:t.rootID,parent_id:null,depth:o,left:r,right:(i(t.items,this.element).length+1)*2}),r++),i(this.element).children(t.items).each(function(){r=h(this,o,r)}),l=l.sort(function(e,n){return e.left-n.left}),l;function h(e,n,d){var f=d+1,p,u,g;if(i(e).children(t.listType).children(t.items).length>0&&(n++,i(e).children(t.listType).children(t.items).each(function(){f=h(i(this),n,f)}),n--),p=(i(e).attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/),n===o?u=t.rootID:(g=i(e).parent(t.listType).parent(t.items).attr(t.attribute||"id").match(t.expression||/(.+)[-=_](.+)/),u=g[2]),p){var v=i(e).children("div").data(),C=i.extend(v,{id:p[2],parent_id:u,depth:n,left:d,right:f});l.push(C)}return d=f+1,d}},_clearEmpty:function(s){function t(e,n,d,f){f&&(n=[d,d=n][0]),i(e).removeClass(n).addClass(d)}var o=this.options,l=i(s).children(o.listType),r=l.has("li").length,h=o.doNotClear||r||o.protectRoot&&i(s)[0]===this.element[0];o.isTree&&t(s,o.branchClass,o.leafClass,h),h||(l.parent().removeClass(o.expandedClass),l.remove())},_getLevel:function(s){var t=1,o;if(this.options.listType)for(o=s.closest(this.options.listType);o&&o.length>0&&!o.is(".ui-sortable");)t++,o=o.parent().closest(this.options.listType);return t},_getChildLevels:function(s,t){var o=this,l=this.options,r=0;return t=t||0,i(s).children(l.listType).children(l.items).each(function(h,e){r=Math.max(o._getChildLevels(e,t+1),r)}),t?r+1:r},_isAllowed:function(s,t,o){var l=this.options,r=this.placeholder.closest(".ui-sortable").nestedSortable("option","maxLevels"),h=this.currentItem.parent().parent(),e=l.disableParentChange&&(typeof s<"u"&&!h.is(s)||typeof s>"u"&&h.is("li"));e||!l.isAllowed(this.placeholder,s,this.currentItem)?(this.placeholder.addClass(l.errorClass),r<o&&r!==0?this.beyondMaxLevels=o-r:this.beyondMaxLevels=1):r<o&&r!==0?(this.placeholder.addClass(l.errorClass),this.beyondMaxLevels=o-r):(this.placeholder.removeClass(l.errorClass),this.beyondMaxLevels=0)}})),i.mjs.nestedSortable.prototype.options=i.extend({},i.ui.sortable.prototype.options,i.mjs.nestedSortable.prototype.options)});
